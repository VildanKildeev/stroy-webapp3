<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>СТРОЙ по КАрману</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: white;
            overflow: hidden;
            background: black;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .background-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -2;
        }
        /* === Отображение города === */
        .selected-city {
            margin-top: 12px;
            font-size: 16px;
            color: #fff;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
            z-index: 10;
        }
        #changeCityButton {
            background: none;
            border: none;
            color: white;
            font-weight: bold;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            padding: 6px 10px;
            border-radius: 6px;
        }
        /* === СЕТКА ПЛИТОК === */
        .grid-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            width: 90%;
            max-width: 400px;
            z-index: 10;
        }
        .grid-row {
            display: flex;
            width: 100%;
            gap: 12px;
        }
        .tile-btn {
            flex: 1;
            color: #333;
            background: #e0d6c8;
            border: 2px solid #c0b0a0;
            padding: 16px 8px;
            font-size: 15px;
            font-weight: bold;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-shadow: none;
            z-index: 1;
        }
        .tile-btn::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            z-index: 0;
            pointer-events: none;
        }
        .tile-btn span {
            position: relative;
            z-index: 1;
            display: block;
        }
        .tile-btn small {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }
        .tile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        #sellMaterialsButton {
            background: #d8e8c8 !important;
            color: #333 !important;
            text-shadow: none !important;
        }
        #sellMaterialsButton:hover {
            background: #c5d8b0 !important;
        }
        /* === БОЛЬШОЙ БАННЕР === */
        .banner-btn {
            width: 100%;
            color: white;
            background: linear-gradient(135deg, #ff6b35, #d4380d);
            border: none;
            padding: 28px 16px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
            text-align: center;
            margin-top: 12px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
        }
        .banner-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        /* === НИЖНЯЯ ПЛАШКА === */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #d8c9b7;
            border-top: 2px solid #c0b0a0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 12px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            font-size: 13px;
            color: #5a4a3a;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-weight: bold;
            cursor: pointer;
            width: 22%;
            max-width: 90px;
            padding: 6px 0;
            border-radius: 12px;
            transition: all 0.2s ease;
            background: #f5f0e6;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-btn span {
            font-size: 13px;
            color: #5a4a3a;
        }
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            background: #e8dccf;
        }
        /* === Модальные окна === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            background: #d8c9b7;
            border: 2px solid #c0b0a0;
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-title {
            font-size: 20px;
            margin-bottom: 16px;
            color: #5a4a3a;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .search-container {
            width: 90%;
            position: relative;
            margin-bottom: 12px;
        }
        .search-container input {
            width: 100%;
            padding: 10px 10px 10px 36px;
            border: 1px solid #c0b0a0;
            border-radius: 8px;
            font-size: 15px;
            background: #e8dccf;
            color: #333;
            outline: none;
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #7d6b59;
            font-size: 16px;
            pointer-events: none;
        }
        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            align-items: center;
            margin-top: 10px;
        }
        .modal-button {
            color: #5a4a3a;
            border: 2px solid #5a4a3a;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            background: #f5f0e6;
            transition: all 0.3s ease;
            width: 90%;
            max-width: 300px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .modal-button:hover {
            background: #e0d6c8;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .close-modal {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            color: #5a4a3a;
            cursor: pointer;
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        /* === ЛИЧНЫЙ КАБИНЕТ === */
        #profilePage {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px 16px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #profilePage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        .profile-header {
            font-size: 20px;
            color: #5a4a3a;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        .profile-card {
            background: #e8dccf;
            border: 1px solid #c0b0a0;
            border-radius: 12px;
            padding: 16px;
            width: 90%;
            max-width: 400px;
            margin-bottom: 16px;
            color: #333;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .profile-card strong {
            color: #7d6b59;
        }
        .profile-button {
            color: #5a4a3a;
            border: 2px solid #5a4a3a;
            padding: 14px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            background: #f5f0e6;
            width: 90%;
            max-width: 300px;
            margin: 8px 0;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .profile-button:hover {
            background: #e0d6c8;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        .back-button {
            margin-top: 20px;
            color: #7d6b59;
            font-size: 15px;
            text-decoration: underline;
            cursor: pointer;
        }
        /* === ФОРМА ЗАЯВКИ === */
        #requestFormPage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #requestFormPage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        .form-title {
            font-size: 20px;
            color: #5a4a3a;
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 16px;
            text-align: left;
            width: 100%;
        }
        .form-group label {
            display: block;
            color: #7d6b59;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #c0b0a0;
            border-radius: 8px;
            background: #e8dccf;
            color: #333;
            font-size: 15px;
        }
        .form-group input:disabled {
            background: #d8c9b7;
            color: #5a4a3a;
            font-weight: bold;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px 0;
        }
        .checkbox-group input {
            width: auto;
        }
        .upload-group {
            margin: 16px 0;
        }
        .upload-group button {
            background: #e0d6c8;
            color: #5a4a3a;
            border: none;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
        }
        .upload-preview {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .upload-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #c0b0a0;
        }
        .footer-contact {
            text-align: center;
            margin-top: 30px;
            font-size: 14px;
            color: #7d6b59;
        }
        /* === СПЕЦТЕХНИКА === */
        #machineryFormPage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #machineryFormPage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        #rentDurationGroup {
            display: none;
        }
        /* === СТРАНИЦА: МОИ ЗАЯВКИ === */
        #myRequestsPage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #myRequestsPage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        .request-card {
            background: #e8dccf;
            border: 1px solid #c0b0a0;
            border-radius: 12px;
            padding: 14px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 12px;
        }
        .request-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }
        .request-actions button {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .request-actions .view-btn {
            background: #4caf50;
            color: white;
        }
        .request-actions .edit-btn {
            background: #2196f3;
            color: white;
        }
        .request-actions .delete-btn {
            background: #f44336;
            color: white;
        }
        /* === ФОРМА АРЕНДЫ ИНСТРУМЕНТА === */
        #toolsFormPage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #toolsFormPage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        /* === ФОРМА: ПРОДАТЬ МАТЕРИАЛЫ === */
        #sellMaterialsPage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #sellMaterialsPage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        /* === ДОСКА ОБЪЯВЛЕНИЙ === */
        #marketplacePage {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100vh;
            background: #d8c9b7;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            color: #333;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #marketplacePage.active {
            display: flex;
            visibility: visible;
            opacity: 1;
            pointer-events: all;
        }
        .ad-card {
            background: #e8dccf;
            border: 1px solid #c0b0a0;
            border-radius: 12px;
            padding: 14px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 12px;
        }
        .ad-card img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
            object-fit: cover;
        }
        .ad-card .ad-title {
            font-weight: bold;
            color: #5a4a3a;
            margin-bottom: 6px;
        }
        .ad-card .ad-meta {
            font-size: 12px;
            color: #7d6b59;
            margin-bottom: 8px;
        }
        .ad-card .ad-text {
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-line;
        }
        /* === ЦЕНТРИРОВКА КНОПОК === */
        .form-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <video autoplay muted loop playsinline class="background-video" id="bgVideo">
        <source src="background.mp4" type="video/mp4">
        Ваш браузер не поддерживает видео.
    </video>
    <audio id="clickSound" src="click.mp3"></audio>
    <!-- Отображение города -->
    <div class="selected-city" id="selectedCityDisplay" style="display: none;">
        <span>Город: <span id="cityName">Не выбран</span></span>
        <button type="button" id="changeCityButton">СМЕНИТЬ</button>
    </div>
    <!-- === СЕТКА ПЛИТОК === -->
    <div class="grid-container" id="buttonContainer">
        <!-- 1-й ряд -->
        <div class="grid-row">
            <button type="button" class="tile-btn" id="masterButton">
                <span>НАНЯТЬ МАСТЕРА</span>
                <small>проверенные специалисты</small>
            </button>
            <button type="button" class="tile-btn" id="machineryButton">
                <span>СПЕЦТЕХНИКА</span>
                <small>аренда / прокат</small>
            </button>
        </div>
        <!-- 2-й ряд -->
        <div class="grid-row">
            <button type="button" class="tile-btn" id="toolsButton">
                <span>АРЕНДА ИНСТРУМЕНТА</span>
                <small>дрели, перфораторы и др.</small>
            </button>
            <button type="button" class="tile-btn" id="sellMaterialsButton">
                <span>ПРОДАТЬ МАТЕРИАЛЫ</span>
                <small>новые и б/у остатки</small>
            </button>
        </div>
        <!-- 3-й ряд — большой баннер -->
        <button type="button" class="banner-btn" id="marketplaceButton">
            🛒 ДОСКА ОБЪЯВЛЕНИЙ СТРОЙМАТЕРИАЛОВ С РУК
        </button>
    </div>
    <!-- === НИЖНЯЯ ПЛАШКА === -->
    <div class="bottom-nav">
        <div class="nav-btn" id="promoButton">
            <span>🎁</span>
            <span>Акции</span>
        </div>
        <div class="nav-btn" id="contactButton">
            <span>📞</span>
            <span>Связаться</span>
        </div>
        <div class="nav-btn" id="aboutButton">
            <span>ℹ️</span>
            <span>О нас</span>
        </div>
        <div class="nav-btn" id="profileButton">
            <span>👤</span>
            <span>Профиль</span>
        </div>
    </div>
    <!-- === Модалка: Регистрация === -->
    <div class="modal" id="formModal">
        <button type="button" class="close-modal">×</button>
        <div class="modal-content">
            <div class="modal-title">РЕГИСТРАЦИЯ</div>
            <form id="inlineForm" style="width: 100%;">
                <div style="margin-bottom: 15px; text-align: left;">
                    <div style="color: #7d6b59; font-size: 14px; margin-bottom: 6px;">Как к Вам обращаться?</div>
                    <input type="text" id="formName" required style="width: 100%; padding: 12px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333; font-size: 16px;">
                </div>
                <div style="margin-bottom: 15px; text-align: left;">
                    <div style="color: #7d6b59; font-size: 14px; margin-bottom: 6px;">Номер телефона</div>
                    <input type="tel" id="formPhone" required style="width: 100%; padding: 12px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333; font-size: 16px;">
                </div>
                <div style="margin-bottom: 20px; text-align: left;">
                    <div style="color: #7d6b59; font-size: 14px; margin-bottom: 6px;">Тип пользователя</div>
                    <select id="formType" required style="width: 100%; padding: 12px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333; font-size: 16px;">
                        <option value="">Выберите тип</option>
                        <option value="ЗАКАЗЧИК">ЗАКАЗЧИК</option>
                        <option value="ПРОДАВЕЦ - МАГАЗИН">ПРОДАВЕЦ - МАГАЗИН</option>
                        <option value="ИСПОЛНИТЕЛЬ">ИСПОЛНИТЕЛЬ</option>
                    </select>
                </div>
                <button type="submit" class="modal-button">ЗАРЕГИСТРИРОВАТЬСЯ</button>
            </form>
        </div>
    </div>
    <!-- === Модалка: Выбор города === -->
    <div class="modal" id="cityModal">
        <button type="button" class="close-modal">×</button>
        <div class="modal-content">
            <div class="modal-title">ВЫБЕРИТЕ ГОРОД</div>
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" id="citySearch" placeholder="Поиск города...">
            </div>
            <div id="cityList"></div>
        </div>
    </div>
    <!-- === ЛИЧНЫЙ КАБИНЕТ === -->
    <div id="profilePage">
        <div class="profile-header">ЛИЧНЫЙ КАБИНЕТ</div>
        <div class="profile-card">
            <div><strong>Имя:</strong> <span id="profileName">Пользователь</span></div>
            <div><strong>Телефон:</strong> <span id="profilePhone">+7 904 666 09 99</span></div>
            <div><strong>Тип:</strong> <span id="profileType">Не указан</span></div>
            <div><strong>Город:</strong> <span id="profileCity">Не указан</span></div>
            <div><strong>Статус:</strong> Проверенный пользователь</div>
        </div>
        <button type="button" class="profile-button" id="myRequestsButton">МОИ ЗАЯВКИ</button>
        <button type="button" class="profile-button" id="myAdsButton">МОИ ОБЪЯВЛЕНИЯ</button>
        <button type="button" class="profile-button" id="logoutButton">ВЫЙТИ</button>
        <div class="back-button" id="backToMain">← Назад</div>
    </div>
    <!-- === СТРАНИЦА: МОИ ЗАЯВКИ === -->
    <div id="myRequestsPage">
        <div class="profile-header">МОИ ЗАЯВКИ</div>
        <div id="requestsList" style="width: 100%;"></div>
        <div class="back-button" id="backToProfileFromRequests">← Назад</div>
    </div>
    <!-- === ФОРМА ЗАЯВКИ === -->
    <div id="requestFormPage">
        <div class="form-title">ОФОРМЛЕНИЕ ЗАЯВКИ</div>
        <form id="requestForm" style="width: 100%;">
            <div class="form-group">
                <label>Имя</label>
                <input type="text" id="reqName" readonly>
            </div>
            <div class="form-group">
                <label>Телефон</label>
                <input type="text" id="reqPhone" readonly>
            </div>
            <div class="form-group">
                <label>Город</label>
                <select id="reqCity" required>
                    <option value="">Выберите город</option>
                </select>
            </div>
            <div class="form-group">
                <label>Адрес (улица, дом, корпус)</label>
                <input type="text" id="reqAddress" placeholder="Укажите точный адрес">
            </div>
            <div class="form-group">
                <label>Тип работ</label>
                <select id="reqWorkType" required>
                    <option value="">Выберите тип работ</option>
                    <option value="1. ЗЕМЛЯНЫЕ РАБОТЫ">1. ЗЕМЛЯНЫЕ РАБОТЫ</option>
                    <option value="2. ФУНДАМЕНТЫ И ОСНОВАНИЯ">2. ФУНДАМЕНТЫ И ОСНОВАНИЯ</option>
                    <option value="3. КЛАДОЧНЫЕ РАБОТЫ">3. КЛАДОЧНЫЕ РАБОТЫ</option>
                    <option value="4. МЕТАЛЛОКОНСТРУКЦИИ">4. МЕТАЛЛОКОНСТРУКЦИИ</option>
                    <option value="5. КРОВЕЛЬНЫЕ РАБОТЫ">5. КРОВЕЛЬНЫЕ РАБОТЫ</option>
                    <option value="6. ОСТЕКЛЕНИЕ И ФАСАДНЫЕ РАБОТЫ">6. ОСТЕКЛЕНИЕ И ФАСАДНЫЕ РАБОТЫ</option>
                    <option value="7. ВНУТРЕННИЕ ИНЖЕНЕРНЫЕ СЕТИ">7. ВНУТРЕННИЕ ИНЖЕНЕРНЫЕ СЕТИ</option>
                    <option value="8. САНТЕХНИЧЕСКИЕ И ВОДОПРОВОДНЫЕ РАБОТЫ">8. САНТЕХНИЧЕСКИЕ И ВОДОПРОВОДНЫЕ РАБОТЫ</option>
                    <option value="9. ОТОПЛЕНИЕ И ТЕПЛОСНАБЖЕНИЕ">9. ОТОПЛЕНИЕ И ТЕПЛОСНАБЖЕНИЕ</option>
                    <option value="10. ВЕНТИЛЯЦИЯ И КОНДИЦИОНИРОВАНИЕ">10. ВЕНТИЛЯЦИЯ И КОНДИЦИОНИРОВАНИЕ</option>
                    <option value="11. ЭЛЕКТРОМОНТАЖНЫЕ РАБОТЫ">11. ЭЛЕКТРОМОНТАЖНЫЕ РАБОТЫ</option>
                    <option value="12. ОТДЕЛОЧНЫЕ РАБОТЫ">12. ОТДЕЛОЧНЫЕ РАБОТЫ</option>
                    <option value="13. МОНТАЖ ПОТОЛКОВ">13. МОНТАЖ ПОТОЛКОВ</option>
                    <option value="14. ПОЛУСУХАЯ СТЯЖКА ПОЛА">14. ПОЛУСУХАЯ СТЯЖКА ПОЛА</option>
                    <option value="15. МАЛЯРНЫЕ РАБОТЫ">15. МАЛЯРНЫЕ РАБОТЫ</option>
                    <option value="16. БЛАГОУСТРОЙСТВО ТЕРРИТОРИИ">16. БЛАГОУСТРОЙСТВО ТЕРРИТОРИИ</option>
                    <option value="17. СТРОИТЕЛЬСТВО ДОМОВ ПОД КЛЮЧ">17. СТРОИТЕЛЬСТВО ДОМОВ ПОД КЛЮЧ</option>
                    <option value="18. ДЕМОНТАЖНЫЕ РАБОТЫ">18. ДЕМОНТАЖНЫЕ РАБОТЫ</option>
                    <option value="19. МОНТАЖ ОБОРУДОВАНИЯ">19. МОНТАЖ ОБОРУДОВАНИЯ</option>
                    <option value="20. РАЗНОРАБОЧИЕ">20. РАЗНОРАБОЧИЕ</option>
                    <option value="21. КЛИНИНГ, УБОРКА ПОМЕЩЕНИЙ">21. КЛИНИНГ, УБОРКА ПОМЕЩЕНИЙ</option>
                    <option value="22. МУЖ НА ЧАС">22. МУЖ НА ЧАС</option>
                    <option value="23. БУРЕНИЕ, УСТРОЙСТВО СКВАЖИН">23. БУРЕНИЕ, УСТРОЙСТВО СКВАЖИН</option>
                    <option value="24. ПРОЕКТИРОВАНИЕ">24. ПРОЕКТИРОВАНИЕ</option>
                    <option value="25. ГЕОЛОГИЯ">25. ГЕОЛОГИЯ</option>
                </select>
            </div>
            <div class="form-group">
                <label>Подробное описание</label>
                <textarea id="reqDescription" placeholder="Опишите задачу подробно..."></textarea>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="reqVisit">
                <label for="reqVisit">Нужен выезд специалиста</label>
            </div>
            <div class="upload-group">
                <label>Фото объекта, плана или проекта</label>
                <button type="button" id="uploadPhotoBtn">Загрузить фото</button>
                <input type="file" id="photoInput" accept="image/*" style="display: none;" multiple>
                <div class="upload-preview" id="photoPreview"></div>
            </div>
            <div class="form-actions">
                <button type="submit" class="profile-button">Оставить заявку</button>
                <div class="back-button" id="backToMainFromRequest">← Назад</div>
            </div>
        </form>
        <div class="footer-contact">
            Если остались вопросы — свяжитесь с нами по телефону или WhatsApp: 
            <a href="tel:+79046660999" style="color: #5a4a3a;">+7 904 666 09 99</a> или 
            <a href="https://wa.me/79046660999" style="color: #5a4a3a;">WhatsApp</a>
        </div>
    </div>
    <!-- === ФОРМА АРЕНДЫ СПЕЦТЕХНИКИ === -->
    <div id="machineryFormPage">
        <div class="form-title">АРЕНДА СПЕЦТЕХНИКИ</div>
        <form id="machineryForm" style="width: 100%;">
            <div class="form-group">
                <label>Имя</label>
                <input type="text" id="machName" readonly>
            </div>
            <div class="form-group">
                <label>Телефон</label>
                <input type="text" id="machPhone" readonly>
            </div>
            <div class="form-group">
                <label>Город</label>
                <input type="text" id="machCity" readonly required>
            </div>
            <div class="form-group">
                <label>Адрес (улица, дом, корпус)</label>
                <input type="text" id="machAddress" placeholder="Укажите точный адрес">
            </div>
            <div class="form-group">
                <label>Тип техники</label>
                <select id="machType" required>
                    <option value="">Выберите категорию</option>
                    <optgroup label="🟡 1. ЭКСКАВАТОРЫ">
                        <option value="ЭКСКАВАТОР: Гусеничные">Гусеничные</option>
                        <option value="ЭКСКАВАТОР: Колёсные">Колёсные</option>
                        <option value="ЭКСКАВАТОР: Мини-экскаваторы">Мини-экскаваторы</option>
                        <option value="ЭКСКАВАТОР: Планировщики">Планировщики</option>
                        <option value="ЭКСКАВАТОР: Длиннорукие (Long Reach)">Длиннорукие (Long Reach)</option>
                        <option value="ЭКСКАВАТОР: С гидромолотом, ямобуром, вибропогружателем">С гидромолотом, ямобуром, вибропогружателем</option>
                    </optgroup>
                    <optgroup label="🟡 2. ПОГРУЗЧИКИ">
                        <option value="ПОГРУЗЧИК: Фронтальные погрузчики">Фронтальные погрузчики</option>
                        <option value="ПОГРУЗЧИК: Мини-погрузчики (Bobcat и аналоги)">Мини-погрузчики (Bobcat и аналоги)</option>
                        <option value="ПОГРУЗЧИК: Телескопические погрузчики">Телескопические погрузчики</option>
                        <option value="ПОГРУЗЧИК: Вилочные погрузчики (дизель, газ, электрические)">Вилочные погрузчики (дизель, газ, электрические)</option>
                    </optgroup>
                    <optgroup label="🟡 3. АВТОКРАНЫ И МАНИПУЛЯТОРЫ">
                        <option value="КРАН: Автокраны (16–100 тонн)">Автокраны (16–100 тонн)</option>
                        <option value="КРАН: Краны-манипуляторы">Краны-манипуляторы</option>
                        <option value="КРАН: Гусеничные краны">Гусеничные краны</option>
                        <option value="КРАН: Башенные краны (сборка/демонтаж)">Башенные краны (сборка/демонтаж)</option>
                    </optgroup>
                    <optgroup label="🟡 4. САМОСВАЛЫ И СПЕЦТРАНСПОРТ">
                        <option value="САМОСВАЛ: Самосвалы 10–30 т">Самосвалы 10–30 т</option>
                        <option value="САМОСВАЛ: Тонар, Шакман, КамАЗ, Scania, MAN и др.">Тонар, Шакман, КамАЗ, Scania, MAN и др.</option>
                        <option value="САМОСВАЛ: Бортовые машины">Бортовые машины</option>
                        <option value="САМОСВАЛ: Низкорамные тралы">Низкорамные тралы</option>
                        <option value="САМОСВАЛ: Вахтовки, автобусы, спецавтомобили">Вахтовки, автобусы, спецавтомобили</option>
                    </optgroup>
                    <optgroup label="🟡 5. АВТОВЫШКИ И ПОДЪЁМНИКИ">
                        <option value="АВТОВЫШКА: Автовышки (10–45 м)">Автовышки (10–45 м)</option>
                        <option value="ПОДЪЁМНИК: Ножничные подъёмники">Ножничные подъёмники</option>
                        <option value="ПОДЪЁМНИК: Коленчатые подъёмники">Коленчатые подъёмники</option>
                        <option value="ПОДЪЁМНИК: Мачтовые и телескопические платформы">Мачтовые и телескопические платформы</option>
                    </optgroup>
                    <optgroup label="🟡 6. ДОРОЖНАЯ ТЕХНИКА">
                        <option value="ДОРОЖНАЯ ТЕХНИКА: Катки (вибрационные, комбинированные)">Катки (вибрационные, комбинированные)</option>
                        <option value="ДОРОЖНАЯ ТЕХНИКА: Асфальтоукладчики">Асфальтоукладчики</option>
                        <option value="ДОРОЖНАЯ ТЕХНИКА: Грейдеры">Грейдеры</option>
                        <option value="ДОРОЖНАЯ ТЕХНИКА: Фрезы дорожные">Фрезы дорожные</option>
                        <option value="ДОРОЖНАЯ ТЕХНИКА: Гудронаторы">Гудронаторы</option>
                    </optgroup>
                    <optgroup label="🟡 7. БЕТОН И СМЕСИТЕЛИ">
                        <option value="БЕТОН: Бетононасосы (стационарные и автобетононасосы)">Бетононасосы (стационарные и автобетононасосы)</option>
                        <option value="БЕТОН: Бетоносмесители">Бетоносмесители</option>
                        <option value="БЕТОН: Растворонасосы">Растворонасосы</option>
                        <option value="БЕТОН: Миксеры">Миксеры</option>
                    </optgroup>
                    <optgroup label="🟡 8. УТИЛИТЫ И ДОП. ОБОРУДОВАНИЕ">
                        <option value="УТИЛИТА: Виброплиты, трамбовки">Виброплиты, трамбовки</option>
                        <option value="УТИЛИТА: Компрессоры">Компрессоры</option>
                        <option value="УТИЛИТА: Генераторы (дизельные/бензиновые)">Генераторы (дизельные/бензиновые)</option>
                        <option value="УТИЛИТА: Сварочные агрегаты">Сварочные агрегаты</option>
                        <option value="УТИЛИТА: Штукатурные станции">Штукатурные станции</option>
                    </optgroup>
                    <optgroup label="🟡 9. КОММУНАЛЬНАЯ ТЕХНИКА">
                        <option value="КОММУНАЛЬНАЯ: Водовозы">Водовозы</option>
                        <option value="КОММУНАЛЬНАЯ: Илососы, каналопромывочные машины">Илососы, каналопромывочные машины</option>
                        <option value="КОММУНАЛЬНАЯ: Поливомоечные">Поливомоечные</option>
                        <option value="КОММУНАЛЬНАЯ: Снегоуборочные">Снегоуборочные</option>
                    </optgroup>
                    <optgroup label="🟡 10. БУРОВАЯ И СПЕЦИАЛЬНАЯ ТЕХНИКА">
                        <option value="БУРОВАЯ: Ямобуры">Ямобуры</option>
                        <option value="БУРОВАЯ: Гидробуры">Гидробуры</option>
                        <option value="БУРОВАЯ: Буровые установки (скважины, сваи)">Буровые установки (скважины, сваи)</option>
                        <option value="БУРОВАЯ: Вибропогружатели">Вибропогружатели</option>
                        <option value="БУРОВАЯ: Машины для забивки свай">Машины для забивки свай</option>
                    </optgroup>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="machNearby">
                <label for="machNearby">Искать ближайшую ко мне технику</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="machMinOrder" checked>
                <label for="machMinOrder">Минимальный заказ (от 4 часов)</label>
            </div>
            <div class="form-group" id="rentDurationGroup">
                <label>Срок аренды (часы)</label>
                <select id="rentDuration">
                    <option value="">Выберите срок аренды</option>
                    <option value="1">1 час</option>
                    <option value="2">2 часа</option>
                    <option value="3">3 часа</option>
                    <option value="4">4 часа</option>
                    <option value="5">5 часов</option>
                    <option value="6">6 часов</option>
                    <option value="7">7 часов</option>
                    <option value="8">8 часов</option>
                    <option value="12">12 часов</option>
                    <option value="24">24 часа</option>
                    <option value="48">48 часов</option>
                    <option value="72">72 часа</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="machPreorder">
                <label for="machPreorder">Предварительный заказ</label>
            </div>
            <div class="form-group" id="preorderFields" style="display: none;">
                <label>Дата аренды</label>
                <input type="date" id="machDate">
                <label>Время начала</label>
                <input type="time" id="machTime">
            </div>
            <div class="upload-group">
                <label>Фото объекта, плана или проекта</label>
                <button type="button" id="uploadPhotoBtnMachinery">Загрузить фото</button>
                <input type="file" id="photoInputMachinery" accept="image/*" style="display: none;" multiple>
                <div class="upload-preview" id="photoPreviewMachinery"></div>
            </div>
            <div class="form-actions">
                <button type="submit" class="profile-button">Арендовать!</button>
                <div class="back-button" id="backToMainFromMachinery">← Назад</div>
            </div>
        </form>
        <div class="footer-contact">
            Если остались вопросы — свяжитесь с нами по телефону или WhatsApp: 
            <a href="tel:+79046660999" style="color: #5a4a3a;">+7 904 666 09 99</a> или 
            <a href="https://wa.me/79046660999" style="color: #5a4a3a;">WhatsApp</a>
        </div>
    </div>
    <!-- === ФОРМА АРЕНДЫ ИНСТРУМЕНТА === -->
    <div id="toolsFormPage">
        <div class="form-title">АРЕНДА ИНСТРУМЕНТА</div>
        <form id="toolsForm" style="width: 100%;">
            <div class="form-group">
                <label>Имя</label>
                <input type="text" id="toolsName" readonly>
            </div>
            <div class="form-group">
                <label>Телефон</label>
                <input type="text" id="toolsPhone" readonly>
            </div>
            <div class="form-group">
                <label>Город</label>
                <input type="text" id="toolsCity" readonly required>
            </div>
            <!-- Выбор инструмента -->
            <div class="form-group">
                <label>Выберите инструмент</label>
                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="toolSearch" placeholder="Поиск инструмента...">
                </div>
                <select id="toolSelect" required style="width: 100%; padding: 10px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333;">
                    <option value="">Выберите инструмент</option>
                </select>
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 10px;">
                    <button type="button" id="addToolBtn" style="background: #e0d6c8; color: #5a4a3a; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer;">+</button>
                    <span style="font-size: 13px; color: #7d6b59;">Добавить ещё</span>
                </div>
            </div>
            <!-- Список выбранных инструментов -->
            <div id="selectedToolsList" style="margin-bottom: 16px;"></div>
            <!-- Срок аренды -->
            <div class="form-group">
                <label>Дата начала аренды</label>
                <input type="date" id="rentStartDate" required>
            </div>
            <div class="form-group">
                <label>Дата окончания аренды</label>
                <input type="date" id="rentEndDate" required>
            </div>
            <!-- Доставка -->
            <div class="checkbox-group">
                <input type="checkbox" id="deliveryNeeded">
                <label for="deliveryNeeded">Нужна доставка</label>
            </div>
            <div class="form-group" id="deliveryAddressGroup" style="display: none;">
                <label>Адрес доставки</label>
                <input type="text" id="deliveryAddress" placeholder="Улица, дом, корпус">
            </div>
            <!-- Описание -->
            <div class="form-group">
                <label>Дополнительное описание (если не нашли нужный инструмент)</label>
                <textarea id="toolsDescription" placeholder="Например: нужен инструмент не из списка..."></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="profile-button">Арендовать</button>
                <div class="back-button" id="backToMainFromTools">← Назад</div>
            </div>
        </form>
        <div class="footer-contact">
            Если остались вопросы — свяжитесь с нами по телефону или WhatsApp: 
            <a href="tel:+79046660999" style="color: #5a4a3a;">+7 904 666 09 99</a> или 
            <a href="https://wa.me/79046660999" style="color: #5a4a3a;">WhatsApp</a>
        </div>
    </div>
    <!-- === ФОРМА: ПРОДАТЬ МАТЕРИАЛЫ === -->
    <div id="sellMaterialsPage">
        <div class="form-title">ПРОДАТЬ СТРОИТЕЛЬНЫЕ МАТЕРИАЛЫ</div>
        <form id="sellMaterialsForm" style="width: 100%;">
            <!-- Наименование (выпадающий список с поиском) -->
            <div class="form-group">
                <label>Наименование</label>
                <div class="search-container">
                    <span class="search-icon">🔍</span>
                    <input type="text" id="materialSearch" placeholder="Поиск материала...">
                </div>
                <select id="materialCategory" required style="width: 100%; padding: 10px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333;">
                    <option value="">Выберите материал</option>
                </select>
            </div>
            <!-- Наименование вручную -->
            <div class="form-group">
                <label>Наименование (вручную)</label>
                <small style="color: #7d6b59; font-size: 12px; display: block; margin: 4px 0 8px;">Если вы не нашли свой товар в списке, укажите наименование вручную</small>
                <input type="text" id="manualMaterialName" placeholder="Введите название материала">
            </div>
            <!-- Состояние -->
            <div class="form-group">
                <label>Состояние</label>
                <div style="display: flex; gap: 20px; margin-top: 8px;">
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="condition" value="новое" required> Новое
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="radio" name="condition" value="б/у"> Б/У
                    </label>
                </div>
            </div>
            <!-- Количество и единицы -->
            <div class="form-group">
                <label>Количество</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="materialQuantity" min="0" required style="flex: 1; padding: 10px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333;">
                    <select id="materialUnit" required style="width: 120px; padding: 10px; border: 1px solid #c0b0a0; border-radius: 8px; background: #e8dccf; color: #333;">
                        <option value="шт">шт</option>
                        <option value="т">т</option>
                        <option value="м³">м³</option>
                        <option value="паллеты">паллеты</option>
                        <option value="рулоны">рулоны</option>
                        <option value="упаковки">упаковки</option>
                        <option value="пог.м">пог.м</option>
                        <option value="листы">листы</option>
                    </select>
                </div>
            </div>
            <!-- Город (авто) -->
            <div class="form-group">
                <label>Город</label>
                <input type="text" id="materialCity" readonly style="background: #d8c9b7; font-weight: bold;">
            </div>
            <!-- Район -->
            <div class="form-group">
                <label>Район</label>
                <input type="text" id="materialDistrict" placeholder="Например: Центральный, Кировский и т.п.">
            </div>
            <!-- Адрес -->
            <div class="form-group">
                <label>Адрес (местонахождение)</label>
                <input type="text" id="materialAddress" placeholder="Улица, дом, корпус">
            </div>
            <!-- Доставка -->
            <div class="checkbox-group">
                <input type="checkbox" id="deliveryAvailable">
                <label for="deliveryAvailable">Возможна доставка</label>
            </div>
            <!-- Фото -->
            <div class="upload-group">
                <label>Фото материалов</label>
                <button type="button" id="uploadMaterialPhotoBtn">Загрузить фото</button>
                <input type="file" id="materialPhotoInput" accept="image/*" style="display: none;" multiple>
                <div class="upload-preview" id="materialPhotoPreview"></div>
            </div>
            <div class="form-actions">
                <button type="submit" class="profile-button">Опубликовать объявление</button>
                <div class="back-button" id="backToMainFromSellMaterials">← Назад</div>
            </div>
        </form>
        <div class="footer-contact">
            Если остались вопросы — свяжитесь с нами по телефону или WhatsApp: 
            <a href="tel:+79046660999" style="color: #5a4a3a;">+7 904 666 09 99</a> или 
            <a href="https://wa.me/79046660999" style="color: #5a4a3a;">WhatsApp</a>
        </div>
    </div>
    <!-- === СТРАНИЦА: ДОСКА ОБЪЯВЛЕНИЙ С РУК === -->
    <div id="marketplacePage">
        <div class="profile-header">ДОСКА ОБЪЯВЛЕНИЙ СТРОЙМАТЕРИАЛОВ С РУК</div>
        <div id="adsList" style="width: 100%;"></div>
        <div class="back-button" id="backToMainFromMarketplace">← Назад</div>
    </div>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // ✅ Константы
        const FORMSPREE_URL = "https://formspree.io/f/xdkdbnnz";
        const TELEGRAM_BOT_TOKEN = "8267098349:AAFtXHR0Vsf_7T2a0ka2Xga95xR8KT_2g5A";
        const TELEGRAM_CHAT_ID = "-1002651098218";
        // 🔗 Замените на ваш Vercel-деплой
        const VERCEL_PROXY_URL = 'https://stroy-webapp.vercel.app/api/proxy';

        let selectedCity = null;
        let currentPage = 'main';
        let currentUserPhone = null;
        let currentUserName = "Пользователь";
        let currentUserType = "";
        const cities = [
            "Москва", "Санкт-Петербург", "Екатеринбург", "Нижний Новгород", "Казань", "Новосибирск", "Челябинск", "Самара", "Омск", "Ростов-на-Дону",
            "Уфа", "Красноярск", "Пермь", "Воронеж", "Волгоград", "Краснодар", "Саратов", "Тюмень", "Тольятти", "Ижевск", "Барнаул", "Улан-Удэ", "Ярославль",
            "Хабаровск", "Магнитогорск", "Томск", "Оренбург", "Кемерово", "Новокузнецк", "Рязань", "Астрахань", "Пенза", "Липецк", "Севастополь"
        ];
        const materialOptions = [
            "Песок", "Щебень", "Гравий", "Отсев", "Керамзит", "Цемент", "Бетон", "Строительные смеси", "Клей", "Затирка",
            "Кирпич силикатный", "Кирпич керамический", "Газоблоки", "Шлакоблоки", "Пеноблоки", "Доска", "Брус", "Вагонка",
            "Фанера", "OSB", "ДСП", "МДФ", "Арматура", "Уголки", "Швеллер", "Листовой металл", "Профтруба", "Профнастил",
            "Металлочерепица", "Гидроизоляция", "Подложки", "Софиты", "Штукатурка", "Шпаклёвка", "Обои", "Плитка", "Ламинат",
            "Краска", "Панели", "Пластиковые окна", "Деревянные окна", "Межкомнатные двери", "Входные двери", "Сантехника",
            "Отопление", "Вентиляция", "Электрика", "Трубы", "Кабель", "Фитинги", "Утеплители", "Сайдинг", "Фасадные панели",
            "Декоративная штукатурка", "Электроинструмент", "Ручной инструмент", "Саморезы", "Дюбели", "Анкера"
        ];
        const toolsList = ["Перфоратор", "Дрель", "Шуруповёрт", "Молоток", "Пила", "Лобзик", "Фен строительный", "Шлифмашина", "Уровень", "Отвёртка"];

        function playSound() {
            const clickSound = document.getElementById('clickSound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play().catch(() => {});
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            currentPage = 'main';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.hide();
        }

        function showMainPage() {
            document.getElementById('profilePage').classList.remove('active');
            document.getElementById('requestFormPage').classList.remove('active');
            document.getElementById('machineryFormPage').classList.remove('active');
            document.getElementById('myRequestsPage').classList.remove('active');
            document.getElementById('toolsFormPage').classList.remove('active');
            document.getElementById('sellMaterialsPage').classList.remove('active');
            document.getElementById('marketplacePage').classList.remove('active');
            document.getElementById('buttonContainer').style.display = 'flex';
            document.getElementById('selectedCityDisplay').style.display = selectedCity ? 'flex' : 'none';
            currentPage = 'main';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.hide();
        }

        function showProfilePage() {
            if (!currentUserPhone || !currentUserName) {
                document.getElementById('formModal').classList.add('active');
                return;
            }
            showMainPage();
            document.getElementById('profilePage').classList.add('active');
            document.getElementById('profileName').textContent = currentUserName;
            document.getElementById('profilePhone').textContent = currentUserPhone;
            document.getElementById('profileType').textContent = currentUserType;
            document.getElementById('profileCity').textContent = selectedCity || 'Не указан';
            currentPage = 'profile';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function showRequestFormPage() {
            if (!selectedCity) {
                initCityModal();
                document.getElementById('cityModal').classList.add('active');
                window.onCitySelected = () => {
                    showRequestFormPage();
                };
                return;
            }
            showMainPage();
            document.getElementById('requestFormPage').classList.add('active');
            document.getElementById('reqName').value = currentUserName;
            document.getElementById('reqPhone').value = currentUserPhone;
            document.getElementById('reqCity').value = selectedCity;
            currentPage = 'request';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function showMachineryFormPage() {
            if (!selectedCity) {
                initCityModal();
                document.getElementById('cityModal').classList.add('active');
                window.onCitySelected = () => {
                    showMachineryFormPage();
                };
                return;
            }
            showMainPage();
            document.getElementById('machineryFormPage').classList.add('active');
            document.getElementById('machName').value = currentUserName;
            document.getElementById('machPhone').value = currentUserPhone;
            document.getElementById('machCity').value = selectedCity;
            currentPage = 'machinery';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function showToolsFormPage() {
            if (!selectedCity) {
                initCityModal();
                document.getElementById('cityModal').classList.add('active');
                window.onCitySelected = () => {
                    showToolsFormPage();
                };
                return;
            }
            showMainPage();
            document.getElementById('toolsFormPage').classList.add('active');
            document.getElementById('toolsName').value = currentUserName;
            document.getElementById('toolsPhone').value = currentUserPhone;
            document.getElementById('toolsCity').value = selectedCity;
            const select = document.getElementById('toolSelect');
            select.innerHTML = '<option value="">Выберите инструмент</option>';
            toolsList.forEach(tool => {
                const opt = document.createElement('option');
                opt.value = tool;
                opt.textContent = tool;
                select.appendChild(opt);
            });
            document.getElementById('selectedToolsList').innerHTML = '';
            currentPage = 'tools';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function showSellMaterialsPage() {
            if (!selectedCity) {
                initCityModal();
                document.getElementById('cityModal').classList.add('active');
                window.onCitySelected = () => {
                    showSellMaterialsPage();
                };
                return;
            }
            showMainPage();
            document.getElementById('sellMaterialsPage').classList.add('active');
            document.getElementById('materialCity').value = selectedCity;
            populateMaterialDropdown();
            currentPage = 'sellMaterials';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function populateMaterialDropdown() {
            const select = document.getElementById('materialCategory');
            const searchInput = document.getElementById('materialSearch');
            select.innerHTML = '<option value="">Выберите материал</option>';
            materialOptions.forEach(material => {
                const opt = document.createElement('option');
                opt.value = material;
                opt.textContent = material;
                select.appendChild(opt);
            });
            searchInput.addEventListener('input', function () {
                const q = this.value.toLowerCase();
                select.innerHTML = '<option value="">Выберите материал</option>';
                materialOptions
                    .filter(material => material.toLowerCase().includes(q))
                    .forEach(material => {
                        const opt = document.createElement('option');
                        opt.value = material;
                        opt.textContent = material;
                        select.appendChild(opt);
                    });
            });
        }

        document.getElementById('sellMaterialsForm').addEventListener('submit', function (e) {
            e.preventDefault();
            playSound();
            const category = document.getElementById('materialCategory').value;
            const manualName = document.getElementById('manualMaterialName').value.trim();
            const name = manualName || category;
            const condition = document.querySelector('input[name="condition"]:checked').value;
            const quantity = document.getElementById('materialQuantity').value;
            const unit = document.getElementById('materialUnit').value;
            const city = document.getElementById('materialCity').value;
            const district = document.getElementById('materialDistrict').value;
            const address = document.getElementById('materialAddress').value;
            const delivery = document.getElementById('deliveryAvailable').checked;
            const files = document.getElementById('materialPhotoInput').files;

            if (!name || !quantity || !address) {
                alert('Заполните обязательные поля: наименование, количество, адрес');
                return;
            }

            const newAd = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                name,
                condition,
                quantity,
                unit,
                city,
                district,
                address,
                delivery,
                photosCount: files.length
            };

            const ads = JSON.parse(localStorage.getItem('userMaterialAds') || '[]');
            ads.push(newAd);
            localStorage.setItem('userMaterialAds', JSON.stringify(ads));

            const message = `
📢 *Новое объявление о продаже материалов*:
*Наименование:* ${name}
*Состояние:* ${condition === 'новое' ? 'Новое' : 'Бывшее в употреблении'}
*Количество:* ${quantity} ${unit}
*Город:* ${city}
*Район:* ${district || 'не указан'}
*Адрес:* ${address}
*Доставка:* ${delivery ? 'Да' : 'Нет'}
*Контакт:* ${currentUserName}, ${currentUserPhone}
            `;

            const encodedMessage = encodeURIComponent(message);
            const telegramUrl = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage?chat_id=${TELEGRAM_CHAT_ID}&text=${encodedMessage}&parse_mode=Markdown`;

            fetch(telegramUrl)
                .then(response => {
                    if (!response.ok) throw new Error('Telegram API error');
                })
                .catch(err => {
                    console.warn('Не удалось отправить в Telegram:', err);
                });

            const formData = new FormData();
            formData.append('name', currentUserName);
            formData.append('phone', currentUserPhone);
            formData.append('city', city);
            formData.append('district', district);
            formData.append('material_name', name);
            formData.append('condition', condition);
            formData.append('quantity', quantity);
            formData.append('unit', unit);
            formData.append('address', address);
            formData.append('delivery', delivery ? 'Да' : 'Нет');
            for (let i = 0; i < files.length; i++) {
                formData.append('photos', files[i]);
            }

            fetch(FORMSPREE_URL, {
                method: 'POST',
                body: formData,
                mode: 'no-cors'
            });

            alert('Объявление о продаже материалов опубликовано!');
            showMainPage();
        });

        document.getElementById('uploadMaterialPhotoBtn').addEventListener('click', () => {
            document.getElementById('materialPhotoInput').click();
        });

        document.getElementById('materialPhotoInput').addEventListener('change', function (e) {
            const preview = document.getElementById('materialPhotoPreview');
            preview.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                preview.appendChild(img);
            });
        });

        document.getElementById('backToMainFromSellMaterials').addEventListener('click', () => {
            playSound();
            showMainPage();
        });

        // === ДОСКА ОБЪЯВЛЕНИЙ ===
        function showMarketplacePage() {
            showMainPage();
            document.getElementById('marketplacePage').classList.add('active');
            currentPage = 'marketplace';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
            loadMarketplaceAds();
        }

        function loadMarketplaceAds() {
            const adsList = document.getElementById('adsList');
            adsList.innerHTML = '<div style="text-align: center; padding: 20px;">Загрузка объявлений...</div>';

            fetch(VERCEL_PROXY_URL)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    if (!data.success || !data.posts || data.posts.length === 0) {
                        adsList.innerHTML = '<div style="text-align: center; color: #7d6b59; padding: 20px;">Нет объявлений</div>';
                        return;
                    }

                    adsList.innerHTML = '';
                    data.posts.forEach(post => {
                        const card = document.createElement('div');
                        card.className = 'ad-card';

                        const date = new Date(post.date).toLocaleString('ru-RU');
                        const title = post.text.split('\n')[0].substring(0, 50) + (post.text.length > 50 ? '...' : '');

                        card.innerHTML = `
                            <div class="ad-title">${title}</div>
                            <div class="ad-meta">📅 ${date}</div>
                            <div class="ad-text">${post.text.replace(/\n/g, '<br>')}</div>
                        `;
                        if (post.photo) {
                            const img = document.createElement('img');
                            img.src = post.photo;
                            img.alt = "Фото";
                            card.appendChild(img);
                        }

                        adsList.appendChild(card);
                    });
                })
                .catch(err => {
                    console.error('Ошибка загрузки объявлений:', err);
                    adsList.innerHTML = `
                        <div style="text-align: center; color: #f44336; padding: 20px;">
                            Не удалось загрузить объявления.<br>
                            Убедитесь, что канал публичный.
                        </div>
                    `;
                });
        }

        window.addEventListener('load', () => {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.ready();
                tg.expand();
                tg.BackButton.onClick(() => {
                    if (currentPage === 'profile') showMainPage();
                    else if (currentPage === 'request') showMainPage();
                    else if (currentPage === 'machinery') showMainPage();
                    else if (currentPage === 'tools') showMainPage();
                    else if (currentPage === 'sellMaterials') showMainPage();
                    else if (currentPage === 'requests') showProfilePage();
                    else if (currentPage === 'marketplace') showMainPage();
                    else closeAllModals();
                });
            }

            const savedCity = localStorage.getItem('selectedCity');
            if (savedCity && cities.includes(savedCity)) {
                selectedCity = savedCity;
                updateCityDisplay();
                updateButtonTitles(selectedCity);
            }

            const savedPhone = localStorage.getItem('userPhone');
            const savedName = localStorage.getItem('userName');
            const savedType = localStorage.getItem('userType');
            if (savedPhone && savedName && savedType) {
                currentUserPhone = savedPhone;
                currentUserName = savedName;
                currentUserType = savedType;
            }

            if (localStorage.getItem('lastPhone')) {
                document.getElementById('formPhone').value = localStorage.getItem('lastPhone');
            }

            document.getElementById('changeCityButton').addEventListener('click', () => {
                playSound();
                initCityModal();
                document.getElementById('cityModal').classList.add('active');
            });

            document.getElementById('masterButton').addEventListener('click', () => {
                playSound();
                showRequestFormPage();
            });
            document.getElementById('machineryButton').addEventListener('click', () => {
                playSound();
                showMachineryFormPage();
            });
            document.getElementById('toolsButton').addEventListener('click', () => {
                playSound();
                showToolsFormPage();
            });
            document.getElementById('sellMaterialsButton').addEventListener('click', () => {
                playSound();
                showSellMaterialsPage();
            });
            document.getElementById('marketplaceButton').addEventListener('click', () => {
                playSound();
                showMarketplacePage();
            });
            document.getElementById('profileButton').addEventListener('click', () => {
                playSound();
                showProfilePage();
            });

            document.getElementById('myRequestsButton').addEventListener('click', () => {
                playSound();
                showMyRequestsPage();
            });
            document.getElementById('backToMain').addEventListener('click', () => {
                playSound();
                showMainPage();
            });
            document.getElementById('logoutButton').addEventListener('click', () => {
                playSound();
                localStorage.removeItem('userPhone');
                localStorage.removeItem('userName');
                localStorage.removeItem('userType');
                currentUserPhone = null;
                currentUserName = "Пользователь";
                showMainPage();
                alert('Вы вышли');
            });

            document.getElementById('backToProfileFromRequests').addEventListener('click', () => {
                playSound();
                showProfilePage();
            });

            document.getElementById('backToMainFromMarketplace').addEventListener('click', () => {
                playSound();
                showMainPage();
            });

            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    playSound();
                    closeAllModals();
                });
            });

            const reqCitySelect = document.getElementById('reqCity');
            reqCitySelect.innerHTML = '<option value="">Выберите город</option>';
            cities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                reqCitySelect.appendChild(opt);
            });

            populateMaterialDropdown();
        });

        function showMyRequestsPage() {
            showMainPage();
            document.getElementById('myRequestsPage').classList.add('active');
            loadUserRequests();
            currentPage = 'requests';
            if (window.Telegram?.WebApp) Telegram.WebApp.BackButton.show();
        }

        function loadUserRequests() {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '<div style="text-align: center; padding: 20px;">Загрузка заявок...</div>';
            const localOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
            displayRequests(localOrders);
        }

        function displayRequests(requests) {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';
            if (requests.length === 0) {
                requestsList.innerHTML = '<div style="text-align: center; color: #7d6b59; padding: 20px;">У вас пока нет заявок</div>';
                return;
            }
            requests.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            requests.forEach((order, index) => {
                const card = document.createElement('div');
                card.className = 'request-card';
                let title = 'Без названия';
                if (order.work_type) title = order.work_type;
                else if (order.mach_type) title = order.mach_type;
                else if (order.tools) title = 'Аренда инструмента';
                card.innerHTML = `
                    <strong>${title}</strong>
                    <div><small>Город: ${order.city}</small></div>
                    <div><small>Дата: ${new Date(order.timestamp).toLocaleString('ru-RU')}</small></div>
                    <div class="request-actions">
                        <button class="view-btn" onclick="viewRequest(${index})">Просмотр</button>
                        <button class="delete-btn" onclick="deleteRequest(${index})">Удалить</button>
                    </div>
                `;
                requestsList.appendChild(card);
            });
        }

        function viewRequest(index) {
            const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');
            const order = orders[index];
            let details = `Имя: ${order.name}
Телефон: ${order.phone}
Город: ${order.city}
Дата: ${new Date(order.timestamp).toLocaleString('ru-RU')}`;
            if (order.work_type) {
                details += `
Тип работ: ${order.work_type}`;
                if (order.visit) details += `
Выезд: Да`;
            } else if (order.mach_type) {
                details += `
Тип техники: ${order.mach_type}`;
            } else if (order.tools) {
                details += `
Аренда инструмента:`;
                order.tools.forEach(t => {
                    details += `
- ${t.name} × ${t.qty}`;
                });
                details += `
С ${order.rent_start} по ${order.rent_end}`;
                if (order.delivery) details += `
Доставка: ${order.delivery_address}`;
            }
            if (order.description) details += `
Описание: ${order.description}`;
            alert(details);
        }

        function deleteRequest(index) {
            if (confirm('Удалить заявку?')) {
                const orders = JSON.parse(localStorage.getItem('userOrders') || '[]');
                orders.splice(index, 1);
                localStorage.setItem('userOrders', JSON.stringify(orders));
                loadUserRequests();
            }
        }

        function updateCityDisplay() {
            const display = document.getElementById('selectedCityDisplay');
            const nameSpan = document.getElementById('cityName');
            if (selectedCity) {
                nameSpan.textContent = selectedCity;
                display.style.display = 'flex';
            } else {
                display.style.display = 'none';
            }
        }

        function getCityInPrepositional(city) {
            const exceptions = {
                "Москва": "в Москве", "Санкт-Петербург": "в Санкт-Петербурге", "Екатеринбург": "в Екатеринбурге",
                "Нижний Новгород": "в Нижнем Новгороде", "Новосибирск": "в Новосибирске", "Казань": "в Казани",
                "Самара": "в Самаре", "Омск": "в Омске", "Челябинск": "в Челябинске", "Уфа": "в Уфе",
                "Ростов-на-Дону": "в Ростове-на-Дону", "Краснодар": "в Краснодаре",
                "Тюмень": "в Тюмени", "Ижевск": "в Ижевске", "Барнаул": "в Барнауле", "Улан-Удэ": "в Улан-Удэ",
                "Ярославль": "в Ярославле", "Хабаровск": "в Хабаровске", "Магнитогорск": "в Магнитогорске",
                "Томск": "в Томске", "Оренбург": "в Оренбурге", "Кемерово": "в Кемерово",
                "Новокузнецк": "в Новокузнецке", "Рязань": "в Рязани", "Астрахань": "в Астрахани",
                "Пенза": "в Пензе", "Липецк": "в Липецке", "Севастополь": "в Севастополе"
            };
            return exceptions[city] || `в ${city.replace(/а$/, 'е').replace(/я$/, 'е')}е`;
        }

        function updateButtonTitles(city) {
            if (!city) return;
            const cityInCase = getCityInPrepositional(city);
            document.getElementById('masterButton').innerHTML = `<span>НАНЯТЬ МАСТЕРА<br><small>${cityInCase}, проверенные специалисты</small></span>`;
            document.getElementById('machineryButton').innerHTML = `<span>СПЕЦТЕХНИКА<br><small>${cityInCase}, аренда / прокат</small></span>`;
            document.getElementById('toolsButton').innerHTML = `<span>АРЕНДА ИНСТРУМЕНТА<br><small>${cityInCase}, дрели, перфораторы и др.</small></span>`;
        }

        function initCityModal() {
            const cityList = document.getElementById('cityList');
            const citySearch = document.getElementById('citySearch');
            function renderCities(filtered = cities) {
                cityList.innerHTML = '';
                filtered.forEach(city => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.textContent = city;
                    btn.className = 'modal-button';
                    btn.onclick = () => {
                        selectedCity = city;
                        playSound();
                        localStorage.setItem('selectedCity', city);
                        document.getElementById('cityModal').classList.remove('active');
                        updateCityDisplay();
                        updateButtonTitles(selectedCity);
                        if (window.onCitySelected) {
                            window.onCitySelected();
                            window.onCitySelected = null;
                        }
                    };
                    cityList.appendChild(btn);
                });
            }
            citySearch.addEventListener('input', () => {
                const q = citySearch.value.toLowerCase().trim();
                const filtered = q ? cities.filter(city => city.toLowerCase().includes(q)) : cities;
                renderCities(filtered);
            });
            renderCities();
        }
    </script>
</body>
</html>